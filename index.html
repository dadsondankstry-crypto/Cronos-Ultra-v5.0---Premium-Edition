<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronos Ultra - Ultimate Hybrid v15 PWA</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#d4af37">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        :root { --gold: #d4af37; --bg: #0a0a0a; --glass: rgba(255, 255, 255, 0.05); --green: #2ecc71; --red: #ff3232; --cyan: #00e5ff; }
        body { background: var(--bg); color: #e0e0e0; font-family: 'Segoe UI', sans-serif; margin: 0; overflow-x: hidden; scroll-behavior: smooth; }

        #nav {
            position: fixed; top: 0; width: 100%; background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px); padding: 10px 0; z-index: 1000;
            border-bottom: 1px solid var(--gold); display: flex; flex-direction: column; align-items: center; gap: 8px;
        }

        #viewer { margin-top: 280px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; width: 100%; }
        
        body.mode-manhwa #viewer img { display: block; width: 100%; max-width: 850px; margin-bottom: 2px; }
        body.mode-manga #viewer img { display: none; max-width: 98vw; max-height: 92vh; object-fit: contain; }
        body.mode-manga #viewer img.active { display: block; }

        #progress-wrapper { width: 95%; max-width: 800px; display: none; flex-direction: column; align-items: center; margin-bottom: 5px; }
        #progress-container { width: 100%; background: #222; height: 10px; border-radius: 5px; overflow: hidden; border: 1px solid #333; }
        #progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--gold), #fff); transition: width 0.2s; }

        .btn-group { display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; width: 98%; }
        
        #urlInput { 
            padding: 10px; border-radius: 4px; background: #111; color: #fff; 
            border: 1px solid #333; width: 300px; min-width: 300px;
            max-width: 95vw; font-size: 13px; transition: width 0.4s ease;
        }

        #status-bar { 
            color: #f1c40f; font-size: 12px; font-weight: bold; text-transform: uppercase; 
            width: 95%; text-align: center; white-space: nowrap; overflow: hidden; 
            text-overflow: ellipsis; margin: 5px 0;
        }

        button {
            padding: 8px 12px; cursor: pointer; background: var(--glass);
            border: 1px solid var(--gold); color: var(--gold);
            font-weight: bold; border-radius: 4px; font-size: 10px; text-transform: uppercase;
        }
        button:hover { background: var(--gold); color: #000; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: #161616; padding: 20px; border-radius: 10px; border: 1px solid var(--gold); width: 85%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        .engine-option { display: block; width: 100%; margin: 8px 0; padding: 10px; text-align: left; background: #222; border: 1px solid #444; color: white; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body onload="initDB()" class="mode-manhwa">

<div id="nav">
    <div class="btn-group">
        <button onclick="abrirModal('modalEngines')" id="engineBtn">FONTE: AUTO</button>
        <input type="text" id="urlInput" onkeypress="handleEnter(event)" placeholder="Nome + Cap ou URL...">
        <button onclick="buscar()">üîç BUSCAR</button>
    </div>
    
    <div class="btn-group">
        <button onclick="mudarCapitulo(-1)">‚óÄ ANT</button>
        <button onclick="mudarCapitulo(1)">PR√ìX ‚ñ∂</button>
        <button id="modeBtn" onclick="toggleMode()">MODO: MANHWA</button>
    </div>

    <div id="status-bar">SISTEMA ONLINE</div>

    <div id="progress-wrapper">
        <div id="progress-container"><div id="progress-bar"></div></div>
        <div id="progress-info" style="font-size:10px; color:var(--gold); margin-top:4px;">0% - [P√ÅGINA 0 DE 0]</div>
    </div>

    <div class="btn-group">
        <button onclick="favoritar()">‚≠ê FAV</button>
        <button onclick="abrirModal('modalFav')">üìã LISTA</button>
        <button onclick="toggleFullscreen()">üì∫ TELA CHEIA</button>
        <button onclick="salvarOffline()" style="border-color: var(--cyan); color: var(--cyan);">üíæ SALVAR OFF</button>
        <button onclick="abrirModal('modalOff')">üìÇ BIBLIOTECA</button>
        <button onclick="baixarZip()" style="border-color: var(--green); color: var(--green);">üì• ZIP</button>
    </div>
</div>

<div id="viewer" onclick="proximaPaginaManga()"></div>

<div id="modalEngines" class="modal" onclick="fecharModalExterno(event)">
    <div class="modal-content">
        <h3>FONTES</h3>
        <button class="engine-option" onclick="setEngine('AUTO', -1)">‚öôÔ∏è AUTO (Tenta todas)</button>
        <button class="engine-option" onclick="setEngine('MangaLivre', 0)">1. MangaLivre</button>
        <button class="engine-option" onclick="setEngine('Mugiwara Padr√£o', 1)">2. Mugiwara (Padr√£o)</button>
        <button class="engine-option" onclick="setEngine('Mugiwara Manga', 2)">3. Mugiwara (manga-nome)</button>
        <button class="engine-option" onclick="setEngine('Mugiwara Modulo', 3)">4. Mugiwara (modulo)</button>
        <button class="engine-option" onclick="setEngine('Mugiwara Vortex', 4)">5. Mugiwara (vortex)</button>
        <button onclick="fecharModal()" style="margin-top:10px; width:100%;">FECHAR</button>
    </div>
</div>

<div id="modalFav" class="modal" onclick="fecharModalExterno(event)">
    <div class="modal-content">
        <h3>‚≠ê Favoritos</h3>
        <div id="lista-favs"></div>
        <hr style="border:0; border-top:1px solid #333; margin:15px 0;">
        <button onclick="limparCacheTotal()" style="border-color:var(--red); color:var(--red); width:100%;">üóëÔ∏è LIMPAR TUDO</button>
        <button onclick="fecharModal()" style="margin-top:10px; width:100%;">FECHAR</button>
    </div>
</div>

<div id="modalOff" class="modal" onclick="fecharModalExterno(event)">
    <div class="modal-content">
        <h3>üìÇ Biblioteca Offline</h3>
        <div id="lista-off"></div>
        <hr style="border:0; border-top:1px solid #333; margin:15px 0;">
        <button onclick="limparCacheTotal()" style="border-color:var(--red); color:var(--red); width:100%;">üóëÔ∏è ESVAZIAR TUDO</button>
        <button onclick="fecharModal()" style="margin-top:10px; width:100%;">FECHAR</button>
    </div>
</div>

<script>
    // Registro do PWA
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').then(() => console.log("PWA Ativo!"));
    }

    const PROXY = "https://fragrant-unit-a421.dadsondankstry.workers.dev/?url=";
    let imagensAtuais = [], tituloAtual = "Manga", isManhwaMode = true, paginaAtual = 0, engineSelecionada = -1, db;
    let cacheData = JSON.parse(localStorage.getItem('readerCache') || '{}');

    function initDB() {
        const req = indexedDB.open("CronosPremiumDB", 1);
        req.onupgradeneeded = e => e.target.result.createObjectStore("mangas", { keyPath: "id" });
        req.onsuccess = e => { db = e.target.result; renderOffline(); renderFavs(); };
    }

    function handleEnter(e) { if (e.key === "Enter") buscar(); }

    function ajustarLarguraInput() {
        const input = document.getElementById('urlInput');
        const tempSpan = document.createElement('span');
        tempSpan.style.visibility = 'hidden';
        tempSpan.style.position = 'absolute';
        tempSpan.style.whiteSpace = 'nowrap';
        tempSpan.style.font = window.getComputedStyle(input).font;
        tempSpan.innerText = input.value || input.placeholder;
        document.body.appendChild(tempSpan);
        const novaLargura = Math.max(300, tempSpan.offsetWidth + 40);
        input.style.width = novaLargura + 'px';
        document.body.removeChild(tempSpan);
    }

    function updateProgress(atual, total) {
        const wrapper = document.getElementById('progress-wrapper');
        const bar = document.getElementById('progress-bar');
        const info = document.getElementById('progress-info');
        wrapper.style.display = 'flex';
        const percent = Math.round((atual / total) * 100);
        bar.style.width = percent + "%";
        info.innerText = `${percent}% - [P√ÅGINA ${atual} DE ${total}]`;
        if (atual === total) setTimeout(() => { wrapper.style.display = 'none'; }, 2000);
    }

    function updateStatus(t) { document.getElementById('status-bar').innerText = t; }

    function setEngine(label, index) {
        engineSelecionada = index;
        document.getElementById('engineBtn').innerText = "FONTE: " + label;
        fecharModal();
    }

    function limparNome(txt) { return txt.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-'); }

    function gerarLinks(input) {
        if (input.startsWith('http')) return [input];
        const partes = input.trim().split(' ');
        const capitulo = partes.pop();
        const nome = limparNome(partes.join(' '));
        return [
            `https://mangalivre.to/manga/${nome}/capitulo-${capitulo}`,
            `https://mugiwarasoficial.com/manga/${nome}/capitulo-${capitulo}`,
            `https://mugiwarasoficial.com/manga/manga-${nome}/capitulo-${capitulo}`,
            `https://mugiwarasoficial.com/manga/${nome}-modulo/capitulo-${capitulo}`,
            `https://mugiwarasoficial.com/manga/${nome}/capitulo-${capitulo}`
        ];
    }

    async function buscar(urlManual) {
        let rawInput = urlManual || document.getElementById('urlInput').value;
        if(!rawInput) return;
        const links = gerarLinks(rawInput);
        let lista = (engineSelecionada === -1) ? links : [links[engineSelecionada]];

        for (let r = 1; r <= 5; r++) {
            for (let url of lista) {
                updateStatus(`BUSCANDO [T${r}]: ${url}...`);
                const sucesso = await carregarURL(url);
                if (sucesso) {
                    document.getElementById('urlInput').value = url;
                    ajustarLarguraInput();
                    executarLoteCache(url);
                    return;
                }
            }
            if (r < 5) await new Promise(res => setTimeout(res, 5000));
        }
        updateStatus("N√ÉO ENCONTRADO");
    }

    async function carregarURL(url, isSilent = false) {
        if(cacheData[url]) {
            if(!isSilent) {
                imagensAtuais = cacheData[url];
                tituloAtual = localStorage.getItem('t_' + url) || "Manga";
                renderizar();
            }
            return true;
        }
        try {
            const res = await fetch(PROXY + encodeURIComponent(url));
            const html = await res.text();
            const doc = new DOMParser().parseFromString(html, "text/html");
            const imgs = Array.from(doc.querySelectorAll('img')).map(i => i.getAttribute('data-src') || i.getAttribute('src')).filter(s => s && s.includes('http') && !/logo|banner|perfil/i.test(s));
            if(imgs.length > 3) {
                cacheData[url] = imgs;
                localStorage.setItem('readerCache', JSON.stringify(cacheData));
                const tit = doc.title.split('|')[0].trim();
                localStorage.setItem('t_' + url, tit);
                if(!isSilent) {
                    imagensAtuais = imgs;
                    tituloAtual = tit;
                    renderizar();
                }
                return true;
            }
        } catch(e) {}
        return false;
    }

    function renderizar() {
        const v = document.getElementById('viewer');
        paginaAtual = 0;
        v.innerHTML = imagensAtuais.map((src, i) => `<img src="${src}" class="${(i===0 || isManhwaMode)?'active':''}" data-index="${i}">`).join('');
        window.scrollTo(0,0);
        updateStatus("LENDO: " + tituloAtual);
    }

    function toggleMode() {
        isManhwaMode = !isManhwaMode;
        document.body.className = isManhwaMode ? "mode-manhwa" : "mode-manga";
        document.getElementById('modeBtn').innerText = isManhwaMode ? "MODO: MANHWA" : "MODO: MANG√Å";
        renderizar();
    }

    function irParaPagina(n) {
        const imgs = document.querySelectorAll('#viewer img');
        if (!imgs.length) return;
        if (isManhwaMode) {
            paginaAtual = Math.max(0, Math.min(n, imgs.length - 1));
            imgs[paginaAtual].scrollIntoView({ behavior: 'smooth' });
        } else {
            imgs[paginaAtual].classList.remove('active');
            paginaAtual = Math.max(0, Math.min(n, imgs.length - 1));
            imgs[paginaAtual].classList.add('active');
            window.scrollTo(0,0);
        }
    }

    function proximaPaginaManga() { if (!isManhwaMode) irParaPagina(paginaAtual + 1); }
    function mudarCapitulo(dir) {
        const input = document.getElementById('urlInput');
        input.value = input.value.replace(/(\d+)(\/*|)$/, (m, n) => (parseInt(n) + dir) + (m.endsWith('/') ? '/' : ''));
        buscar();
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === "ArrowRight") irParaPagina(paginaAtual + 1);
        if (e.key === "ArrowLeft") irParaPagina(paginaAtual - 1);
    });

    async function salvarOffline() {
        if(!imagensAtuais.length) return;
        updateStatus("SALVANDO...");
        const blobs = [];
        for(let i=0; i<imagensAtuais.length; i++) {
            try {
                const r = await fetch(PROXY + encodeURIComponent(imagensAtuais[i]));
                const b = await r.blob();
                const b64 = await new Promise(res => { const rd = new FileReader(); rd.onloadend = () => res(rd.result); rd.readAsDataURL(b); });
                blobs.push(b64);
                updateProgress(i+1, imagensAtuais.length);
            } catch(e) {}
        }
        db.transaction("mangas", "readwrite").objectStore("mangas").put({ id: tituloAtual, imgs: blobs });
        renderOffline();
        updateStatus("SALVO!");
    }

    function renderOffline() {
        if(!db) return;
        db.transaction("mangas").objectStore("mangas").getAll().onsuccess = e => {
            document.getElementById('lista-off').innerHTML = e.target.result.map(i => `<div style="display:flex; justify-content:space-between; margin-bottom:5px; background:rgba(255,255,255,0.05); padding:5px;"><span onclick="lerOff('${i.id}')" style="cursor:pointer;">${i.id}</span><button onclick="deletarOff('${i.id}')">‚ùå</button></div>`).join('');
        };
    }
    function lerOff(id) { db.transaction("mangas").objectStore("mangas").get(id).onsuccess = e => { imagensAtuais = e.target.result.imgs; tituloAtual = id; renderizar(); fecharModal(); }; }
    function deletarOff(id) { db.transaction("mangas", "readwrite").objectStore("mangas").delete(id).onsuccess = () => renderOffline(); }

    async function baixarZip() {
        if(!imagensAtuais.length) return;
        updateStatus("ZIPANDO...");
        const zip = new JSZip();
        for(let i=0; i<imagensAtuais.length; i++) {
            try {
                const r = await fetch(PROXY + encodeURIComponent(imagensAtuais[i]));
                zip.file(`${i+1}.jpg`, await r.blob());
                updateProgress(i+1, imagensAtuais.length);
            } catch(e) {}
        }
        zip.generateAsync({type:"blob"}).then(b => saveAs(b, `${tituloAtual}.zip`));
    }

    function favoritar() {
        let favs = JSON.parse(localStorage.getItem('favs_cronos') || '[]');
        let url = document.getElementById('urlInput').value;
        if(!favs.find(x => x.u === url)) {
            favs.push({ t: tituloAtual, u: url });
            localStorage.setItem('favs_cronos', JSON.stringify(favs));
            renderFavs(); updateStatus("FAVORITADO!");
        }
    }
    function renderFavs() {
        const f = JSON.parse(localStorage.getItem('favs_cronos') || '[]');
        document.getElementById('lista-favs').innerHTML = f.map(i => `<div style="display:flex; justify-content:space-between; margin-bottom:5px; background:rgba(255,255,255,0.05); padding:5px;"><span onclick="buscar('${i.u}')" style="cursor:pointer;">${i.t}</span><button onclick="removerFav('${i.u}')">‚ùå</button></div>`).join('');
    }
    function removerFav(u) { let f = JSON.parse(localStorage.getItem('favs_cronos') || '[]').filter(x => x.u !== u); localStorage.setItem('favs_cronos', JSON.stringify(f)); renderFavs(); }

    async function executarLoteCache(urlBase) {
        for(let i=1; i<=3; i++) {
            let p = urlBase.replace(/(\d+)(\/*|)$/, (m, n) => (parseInt(n) + i) + (m.endsWith('/') ? '/' : ''));
            if(!cacheData[p]) await carregarURL(p, true);
        }
    }

    function limparCacheTotal() { localStorage.clear(); location.reload(); }
    function toggleFullscreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
    function abrirModal(id) { document.getElementById(id).style.display = 'flex'; }
    function fecharModal() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
    function fecharModalExterno(e) { if(e.target.className === 'modal') fecharModal(); }
</script>
</body>
</html>